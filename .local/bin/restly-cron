#!/bin/bash
set -euo pipefail
set -x

cmd=$1

bash -n $(command -v "$0")

if [ -e /sys/class/power_supply/AC/online ]
then
    # Don't run on battery power.
    test "$(cat /sys/class/power_supply/AC/online)" -eq 1
fi

if nmcli -t -f GENERAL.DEVICE,GENERAL.METERED dev show "$(ip route list 0/0 | sed -r 's/.*dev (\S*).*/\1/g')" | grep yes
then
    echo "Refusing to run while on metered connection, unset flag in Gnome Settings > Wi-Fi > Connected Network > Details to continue." 1>&2
    exit 1
fi

nice=""

# To test whether this has the desired effect, use
# https://github.com/brendangregg/bpf-perf-tools-book/blob/master/originals/Ch06_CPUs/cpufreq.bt
cgroup="/sys/fs/cgroup/user.slice/user-$(id --user).slice/user@$(id --user).service/app.slice/restly-${cmd}.service"
if [ -f "$cgroup/cpu.uclamp.max" ] && [ $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor) == "schedutil" ]
then
    # Uclamp is a hinting mechanism that allows the scheduler to understand the
    # performance requirements and restrictions of the tasks, thus it helps the
    # scheduler to make a better decision. And when schedutil cpufreq governor is
    # used, util clamp will influence the CPU frequency selection as well.
    #
    # Only request a part of a big core's CPU cycles. This allows the kernel to
    # move us to a little core, or to run the big core at a low cpufreq.
    #
    # Tested on AMD Ryzen 7 3800X 8-Core Processor with Fedora 39. cpufreq.bt
    # confirmed that restly ran at 2.2GHz with uclamp.max=25 and 3.8GHz with
    # uclamp.max=100.
    #
    # TODO: Use CPU base MHz / CPU max MHz here to cause the CPU to run at base
    # freq?
    echo -n "25" > "$cgroup/cpu.uclamp.max"
fi

config="${HOME}/.config/restly"
for server_conf in $(find "$HOME/.config/restly/" -maxdepth 1 -name '*.sh' | shuf)
do
    repo="$(basename "$server_conf" .sh)"

    if [ "$cmd" = backup ]
    then
        $nice restly "$repo" $@
    else
        gnome-session-inhibit --inhibit suspend \
            $nice \
            restly "$repo" $@
    fi
done
